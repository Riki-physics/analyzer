<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>等間隔マーカー実験 x-t / v-t グラフ</title>

  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --border-soft: #cbd5e1;
      --text-main: #0f172a;
      --text-sub: #475569;
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 1rem;
      background: linear-gradient(#f8fafc, #f1f5f9);
      color: var(--text-main);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    header { margin-bottom: 1rem; }

    h1 {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
      letter-spacing: 0.03em;
    }
    h1 span.accent {
      font-size: 0.9rem;
      color: var(--accent);
      font-weight: 500;
    }

    .controls {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 0.75rem 0.9rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .controls-main {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }

    label {
      font-size: 0.9rem;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f8fafc;
    }
    label span.tag {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    input[type="number"] {
      width: 4rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
      font-size: 0.9rem;
    }

    input[type="range"] {
      width: 120px;
    }

    button {
      font-size: 0.9rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      cursor: pointer;
      background: #ffffff;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button:hover {
      background: #f1f5f9;
      transform: translateY(-1px);
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-sub);
      line-height: 1.4;
      margin-left: auto;
      max-width: 380px;
    }

    .tap-area-wrapper {
      margin-top: 0.9rem;
      display: flex;
      justify-content: center;
    }

    #tapButton {
      width: min(420px, 100%);
      height: 22vh;
      min-height: 130px;
      max-height: 220px;
      font-size: 1.3rem;
      font-weight: 650;
      border-radius: 18px;
      border: 2px solid var(--accent);
      background: #eff6ff;
      color: #1e3a8a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      box-shadow: 0 6px 20px rgba(37,99,235,0.15);
    }
    #tapButton span.sub {
      font-size: 0.8rem;
      color: var(--text-sub);
      font-weight: 400;
    }
    #tapButton:active {
      transform: scale(0.98);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 0.8rem;
      margin-top: 0.8rem;
    }
    @media (max-width: 980px) {
      .layout {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      }
    }
    @media (max-width: 780px) {
      .controls { flex-direction: column; align-items: flex-start; }
      .hint { margin-left: 0; }
      .layout { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 0.55rem 0.7rem 0.65rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 0.98rem;
      margin: 0 0 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      letter-spacing: 0.02em;
    }
    .card h2 span.badge {
      font-size: 0.7rem;
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .small {
      font-size: 0.78rem;
      color: var(--text-sub);
      line-height: 1.4;
      margin-top: 0.3rem;
    }

    canvas {
      width: 100%;
      height: 200px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.76rem;
      color: var(--text-main);
    }
    th, td {
      border-bottom: 1px solid var(--border-soft);
      padding: 0.15rem 0.25rem;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: var(--text-sub);
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(2n) td { background: #f8fafc; }
    tbody tr:hover td { background: #e0f2fe; }

    td:first-child, th:first-child { text-align: center; }

    .table-wrap {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
    }
  </style>
</head>

<body>
<div class="app">
<header>
  <h1>等間隔マーカー実験 <span class="accent">Tap → x-t / v-t graph</span></h1>
</header>

<section class="controls">
  <div class="controls-main">
    <label>
      <span class="tag">marker</span>
      Δx:
      <input id="dxSlider" type="range" min="0.01" max="1.00" step="0.01" value="0.10">
      <input id="dxInput" type="number" step="0.01" value="0.10"> m
    </label>
    <button id="startButton">▶ 測定開始</button>
    <button id="stopButton">■ 測定終了</button>
    <button id="resetButton">⟳ リセット</button>
  </div>
  <div class="hint">
    マーカー通過時にタップ。<br>
    x = (タップ番号 − 1) × Δx<br>
    Spaceキーでも記録できます。
  </div>
</section>

<div class="tap-area-wrapper">
  <button id="tapButton">
    タップして記録
    <span class="sub">（測定中のみ有効）</span>
  </button>
</div>

<section class="layout">
  <article class="card">
    <h2>データ一覧 <span class="badge">log</span></h2>
    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th>#</th><th>t [s]</th><th>x [m]</th><th>Δt [s]</th><th>v [m/s]</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </article>

  <article class="card">
    <h2>x-t グラフ <span class="badge">position</span></h2>
    <canvas id="xtCanvas" width="400" height="240"></canvas>
  </article>

  <article class="card">
    <h2>v-t グラフ <span class="badge">velocity</span></h2>
    <canvas id="vtCanvas" width="400" height="240"></canvas>
    <div class="small">
      平均加速度：<strong id="aDisplay">a: -</strong>
    </div>
  </article>
</section>
</div>

<script>
let tapTimes=[],positions=[],vTimes=[],velocities=[];
let startTime=null,isMeasuring=false;

const dxInput=document.getElementById('dxInput');
const dxSlider=document.getElementById('dxSlider');
const tapButton=document.getElementById('tapButton');
const startButton=document.getElementById('startButton');
const stopButton=document.getElementById('stopButton');
const resetButton=document.getElementById('resetButton');
const dataTableBody=document.querySelector('#dataTable tbody');
const xtCanvas=document.getElementById('xtCanvas');
const vtCanvas=document.getElementById('vtCanvas');
const aDisplay=document.getElementById('aDisplay');

const nowSec=()=>performance.now()/1000;

dxSlider.oninput=()=>dxInput.value=parseFloat(dxSlider.value).toFixed(2);
dxInput.oninput=()=>dxSlider.value=dxInput.value;

function resetAll(){
  tapTimes=[];positions=[];vTimes=[];velocities=[];
  startTime=null;dataTableBody.innerHTML='';
  [xtCanvas,vtCanvas].forEach(c=>c.getContext('2d').clearRect(0,0,c.width,c.height));
  aDisplay.textContent='a: -';
}
startButton.onclick=()=>{resetAll();isMeasuring=true;}
stopButton.onclick=()=>isMeasuring=false;
resetButton.onclick=()=>{resetAll();isMeasuring=false;}

tapButton.onclick=handleTap;
document.onkeydown=e=>{if(e.code==='Space'){e.preventDefault();handleTap();}}

function handleTap(){
  if(!isMeasuring)return;
  const dx=parseFloat(dxInput.value)||0.1;
  const t=nowSec();
  if(startTime===null)startTime=t;
  const tt=t-startTime;
  const x=tapTimes.length*dx;
  tapTimes.push(tt);positions.push(x);
  updateTable();computeVelocity();drawGraphs();
}

function updateTable(){
  dataTableBody.innerHTML='';
  tapTimes.forEach((t,i)=>{
    const dt=i? (t-tapTimes[i-1]).toFixed(3):'-';
    const v=i? ((positions[i]-positions[i-1])/(t-tapTimes[i-1])).toFixed(3):'-';
    dataTableBody.innerHTML+=
      `<tr><td>${i+1}</td><td>${t.toFixed(3)}</td><td>${positions[i].toFixed(3)}</td><td>${dt}</td><td>${v}</td></tr>`;
  });
}

function computeVelocity(){
  vTimes=[];velocities=[];
  for(let i=1;i<tapTimes.length;i++){
    const dt=tapTimes[i]-tapTimes[i-1];
    vTimes.push((tapTimes[i]+tapTimes[i-1])/2);
    velocities.push((positions[i]-positions[i-1])/dt);
  }
}

function drawGraphs(){
  drawScatter(xtCanvas,tapTimes,positions,'t [s]','x [m]','#facc15');
  drawScatter(vtCanvas,vTimes,velocities,'t [s]','v [m/s]','#22c55e');
  if(vTimes.length>1){
    const a=calcSlope(vTimes,velocities);
    aDisplay.textContent='a ≈ '+a.toFixed(3)+' m/s²';
  }
}

function calcSlope(x,y){
  const n=x.length;
  const mx=x.reduce((a,b)=>a+b)/n;
  const my=y.reduce((a,b)=>a+b)/n;
  let num=0,den=0;
  for(let i=0;i<n;i++){num+=(x[i]-mx)*(y[i]-my);den+=(x[i]-mx)**2;}
  return num/den;
}

function drawScatter(c,xs,ys,xl,yl,col){
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(!xs.length)return;
  const m=40,w=c.width-80,h=c.height-80;
  const minX=Math.min(...xs),maxX=Math.max(...xs);
  const minY=Math.min(...ys),maxY=Math.max(...ys);
  const tx=x=>m+(x-minX)/(maxX-minX||1)*w;
  const ty=y=>m+h-(y-minY)/(maxY-minY||1)*h;
  ctx.strokeStyle='#94a3b8';
  ctx.strokeRect(m,m,w,h);
  ctx.fillStyle=col;
  xs.forEach((x,i)=>{ctx.beginPath();ctx.arc(tx(x),ty(ys[i]),4,0,Math.PI*2);ctx.fill();});
}
</script>
</body>
</html>
